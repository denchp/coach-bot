<html>
    <script type="module" src="/js/topwords-ws-client.js"></script>
    <body>
        <script>
            class Store {
                constructor(transformer, initializer) {
                    this.data = new Map();
                    this.transformer = transformer;
                    this.initializer = initializer;
                }
                set(name) {
                    if (this.data.has(name)) {
                        this.data.set(name, this.transformer(name, this.data.get(name)));
                    } else {
                        this.data.set(name, this.initializer(name));
                    }
                }
                get(name) {
                    return this.data.get(name);
                }
            }
        </script>
        <script>
            const whitelist = [ 'fuck', 'shit', 'ass', 'bitch', 'crap' ];

            var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
            var SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent
            const wordStore = new Store((name, value) => value + 1, () => 1);
            var recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.maxAlternatives = 1;
            recognition.addEventListener("result", (e) => {
                recognition.stop();
                const result = e.results[0]
                const { transcript } = result[0];
                const processed = transcript.replace(/[^a-z\s]/gi, "").toUpperCase().split(/\s+/).filter(_ => _);
                for (const word of processed) {
                    if (word.length > 5 || whitelist.some(w => w.toLowerCase() === word)) 
                        wordStore.set(word);
                }

                computeTop();
            });
    
    
            recognition.addEventListener("end", (e) => {
                recognition.start();
            })
            recognition.start();
        </script>
        <script>
            import ws from '/js/topwords-ws-client.js';
            let work_id = 0;
            function computeTop() {
                clearTimeout(work_id);
                setTimeout(() => {
                    const items = Array.from(wordStore.data.entries());
                    const sorted = items.sort((a, b) => b[1] - a[1]).slice(0, 10);
                    document.getElementById("output").innerHTML = `<ol>${sorted.map(([name, count]) => {
                        return `<li><span class="name">${name}</span> (<span class="count">${count}</span>)`;
                    }).join("")}</ol>`;
                }, 10);

                ws.send('Hello!!!');
            }
        </script>
        <h1>Top Words</h1>
        <div id="output"></div>
    </body>
</html>